name: ðŸ”§ CI/CD Preview

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: '18'

jobs:
  # ðŸ§ª Test and Build
  build-and-test:
    name: ðŸ§ª Build & Test
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v4
    
    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: ðŸ“¦ Install Dependencies
      run: |
        cd frontend
        npm ci --prefer-offline --no-audit
    
    - name: ï¿½ Lint Check
      run: |
        cd frontend
        npm run lint 2>/dev/null || echo "âš ï¸ Lint nÃ£o configurado, pulando..."
    
    - name: ðŸ”¨ Build Test
      run: |
        cd frontend
        npm run build
        echo "âœ… Build successful"
        
    - name: ðŸ“Š Build Report
      run: |
        cd frontend
        if [ -d "dist" ]; then
          BUILD_SIZE=$(du -sh dist 2>/dev/null | cut -f1 || echo "N/A")
          FILE_COUNT=$(find dist -type f 2>/dev/null | wc -l || echo "0")
          echo "## ðŸ”¨ Build Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“ **Build Size**: $BUILD_SIZE" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“„ **Files**: $FILE_COUNT files" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Status**: Build successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ï¿½ Ready for deployment!" >> $GITHUB_STEP_SUMMARY
          echo "Este PR estÃ¡ pronto para merge e deploy automÃ¡tico." >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Build directory not found" >> $GITHUB_STEP_SUMMARY
        fi

  # ðŸŒ Preview Deployment (opcional)
  preview-deploy:
    name: ðŸŒ Preview Deploy
    needs: build-and-test
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.labels.*.name, 'preview')
    
    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v4
    
    - name: ðŸŒ Deploy Preview
      uses: amondnet/vercel-action@v25
      id: vercel-preview
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        working-directory: ./frontend
        github-comment: true
      continue-on-error: true
    
    - name: ðŸ“‹ Preview Summary
      run: |
        echo "## ðŸŒ Preview Deployment" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.vercel-preview.outcome }}" == "success" ]; then
          echo "âœ… **Preview URL**: ${{ steps.vercel-preview.outputs.preview-url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Notes:" >> $GITHUB_STEP_SUMMARY
          echo "- Preview serÃ¡ removida quando o PR for fechado" >> $GITHUB_STEP_SUMMARY
          echo "- Backend usarÃ¡ a API de produÃ§Ã£o" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Preview deployment falhou**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Verifique os secrets do Vercel ou adicione a label 'preview' ao PR" >> $GITHUB_STEP_SUMMARY
        fi