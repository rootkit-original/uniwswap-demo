name: ğŸš€ Deploy UniwSwap

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  # ğŸ”¨ Build and Test
  build:
    name: ğŸ”¨ Build & Test
    runs-on: ubuntu-latest
    
    outputs:
      build-success: ${{ steps.build-check.outputs.success }}
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
    
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: ğŸ“¦ Install Dependencies
      run: |
        cd frontend
        npm ci --prefer-offline --no-audit
    
    - name: ğŸ”¨ Build Frontend
      id: build-frontend
      run: |
        cd frontend
        npm run build
        echo "âœ… Build completed successfully"
    
    - name: ï¿½ Build Analysis
      id: build-check
      run: |
        cd frontend
        if [ -d "dist" ]; then
          BUILD_SIZE=$(du -sh dist | cut -f1)
          FILE_COUNT=$(find dist -type f | wc -l)
          echo "Build size: $BUILD_SIZE"
          echo "Files: $FILE_COUNT"
          echo "success=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ Build directory not found"
          echo "success=false" >> $GITHUB_OUTPUT
          exit 1
        fi
    
    - name: ï¿½ğŸ“ Upload Build Artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: frontend-build
        path: frontend/dist/
        retention-days: 1

  # ğŸŒ Deploy to Vercel
  deploy-vercel:
    name: ğŸŒ Deploy Frontend
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && needs.build.outputs.build-success == 'true'
    
    outputs:
      deployment-url: ${{ steps.vercel-deploy.outputs.preview-url }}
      deploy-status: ${{ steps.deploy-status.outputs.status }}
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
    
    - name: ğŸ“ Download Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: frontend-build
        path: frontend/dist/
    
    - name: ğŸŒ Deploy to Vercel
      id: vercel-deploy
      uses: amondnet/vercel-action@v25
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        working-directory: ./frontend
        vercel-args: '--prod'
      continue-on-error: true
    
    - name: ğŸ“Š Check Deploy Status
      id: deploy-status
      run: |
        if [ "${{ steps.vercel-deploy.outcome }}" == "success" ]; then
          echo "âœ… Vercel deployment successful"
          echo "status=success" >> $GITHUB_OUTPUT
        else
          echo "âŒ Vercel deployment failed"
          echo "status=failed" >> $GITHUB_OUTPUT
        fi

  # â˜ï¸ Deploy to Fly.io
  deploy-flyio:
    name: â˜ï¸ Deploy Backend
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    outputs:
      deploy-status: ${{ steps.fly-status.outputs.status }}
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Setup Fly CLI
      uses: superfly/flyctl-actions/setup-flyctl@master
    
    - name: ğŸš€ Deploy to Fly.io
      id: fly-deploy
      run: flyctl deploy --remote-only --verbose
      env:
        FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      continue-on-error: true
    
    - name: ğŸ“Š Check Fly Deploy Status
      id: fly-status
      run: |
        if [ "${{ steps.fly-deploy.outcome }}" == "success" ]; then
          echo "âœ… Fly.io deployment successful"
          echo "status=success" >> $GITHUB_OUTPUT
        else
          echo "âŒ Fly.io deployment failed"
          echo "status=failed" >> $GITHUB_OUTPUT
        fi

  # ğŸ“‹ Summary
  summary:
    name: ğŸ“‹ Deployment Summary
    needs: [build, deploy-vercel, deploy-flyio]
    runs-on: ubuntu-latest
    if: always() && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“‹ Create Detailed Summary
      run: |
        echo "# ğŸš€ UniwSwap Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ“Š Build Status" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ”¨ Build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸš€ Deployment Status" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸŒ Frontend (Vercel): ${{ needs.deploy-vercel.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- â˜ï¸ Backend (Fly.io): ${{ needs.deploy-flyio.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Links section
        echo "## ğŸ”— Application Links" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.deploy-vercel.outputs.deployment-url }}" != "" ]; then
          echo "- ğŸŒ **Frontend**: ${{ needs.deploy-vercel.outputs.deployment-url }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "- ğŸŒ **Frontend**: âš ï¸ URL not available" >> $GITHUB_STEP_SUMMARY
        fi
        echo "- â˜ï¸ **Backend API**: https://uniwswap-backend.fly.dev" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“Š **Health Check**: https://uniwswap-backend.fly.dev/health" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Commit info
        echo "## ğŸ“‹ Commit Information" >> $GITHUB_STEP_SUMMARY
        echo "- **SHA**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Author**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        if [ "${{ github.event.head_commit.message }}" != "" ]; then
          echo "- **Message**: ${{ github.event.head_commit.message }}" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Next steps
        echo "## ğŸ¯ Next Steps" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.deploy-vercel.result }}" == "success" ] && [ "${{ needs.deploy-flyio.result }}" == "success" ]; then
          echo "âœ… **Deployment successful!** Your app is live and ready to use." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ§ª Test your deployment:" >> $GITHUB_STEP_SUMMARY
          echo "1. Open the frontend URL above" >> $GITHUB_STEP_SUMMARY
          echo "2. Check backend health at the health check URL" >> $GITHUB_STEP_SUMMARY
          echo "3. Test core functionality" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Deployment had issues.** Check the logs above for details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ” Troubleshooting:" >> $GITHUB_STEP_SUMMARY
          echo "1. Check workflow logs for error details" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify all secrets are configured correctly" >> $GITHUB_STEP_SUMMARY
          echo "3. Review the deployment guides in \`.github/\`" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: ğŸ”” Deployment Notification
      if: always()
      run: |
        if [ "${{ needs.deploy-vercel.result }}" == "success" ] && [ "${{ needs.deploy-flyio.result }}" == "success" ]; then
          echo "ğŸ‰ Both frontend and backend deployed successfully!"
        elif [ "${{ needs.deploy-vercel.result }}" == "success" ] || [ "${{ needs.deploy-flyio.result }}" == "success" ]; then
          echo "âš ï¸ Partial deployment: One service deployed, but there were issues with the other."
        else
          echo "âŒ Deployment failed for both services. Please check the logs."
          exit 1
        fi